{% extends "templates/wiki/layout.html" %}
{% from "templates/wiki/macros/buttons.html" import ghost_button, render_icon, dropdown, dropdown_item, dropdown_end %}

{% block title %}
    {{ doc.title }}
{% endblock %}

{% block body %}
<div x-data="{ ...wikiDocument(), ...tocScrollSpy() }" x-init="$store.navigation.init()">
    <!-- Main Content -->
    <article class="max-w-4xl mx-auto xl:mr-72 transition-opacity duration-150"
             :class="{ 'opacity-50': $store.navigation.loading }">
        <!-- Page Header -->
        <header class="mb-8 pb-4 border-b border-[var(--outline-gray-1)]">
            <h1 id="wiki-page-title" class="text-3xl font-bold text-[var(--ink-gray-9)] mb-4">{{ doc.title }}</h1>

            <!-- Action Buttons -->
            <div class="flex items-center gap-3">
                <!-- Copy Markdown Button -->
                <button @click="copyMarkdown()"
                        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200 cursor-pointer">
                    <template x-if="!copied">
                        {{ render_icon("clipboard") }}
                    </template>
                    <template x-if="copied">
                        {{ render_icon("check", "text-[var(--ink-green-2)]") }}
                    </template>
                    <span x-text="copied ? 'Copied!' : 'Copy Markdown'"></span>
                </button>

                <!-- Ask AI Dropdown -->
                {% set ai_providers = [
                    {"key": "claude", "text": "Ask Claude", "icon": "claude"},
                    {"key": "openai", "text": "Ask OpenAI", "icon": "openai"},
                    {"key": "t3", "text": "Ask T3 Chat", "icon": "t3"},
                    {"key": "perplexity", "text": "Ask Perplexity", "icon": "perplexity"}
                ] %}
                {{ dropdown(text="Ask AI", icon="sparkles") }}
                    {% for provider in ai_providers %}
                        {{ dropdown_item(text=provider.text, icon=provider.icon, href_expr="getAIUrl('" ~ provider.key ~ "')") }}
                    {% endfor %}
                {{ dropdown_end() }}

                <!-- Edit Page Link -->
                {{ ghost_button(text="Edit Page", icon="edit", href=doc.get_edit_link(), id="wiki-edit-link") }}
            </div>
        </header>

        <!-- Page Content -->
        <div class="prose prose-lg max-w-none" id="wiki-content">
            {{ rendered_content }}
        </div>

        <!-- Previous/Next Navigation -->
        <nav id="wiki-nav-buttons" class="mt-12 pt-8 border-t border-[var(--outline-gray-1)]">
            {% if prev_doc or next_doc %}
            <div class="flex items-stretch gap-4 {{ 'justify-between' if prev_doc and next_doc else ('justify-start' if prev_doc else 'justify-end') }}">
                {% if prev_doc %}
                <a href="/{{ prev_doc.route }}"
                   @click.prevent="$store.navigation.navigateTo('{{ prev_doc.route }}')"
                   @mouseenter="$store.navigation.prefetch('{{ prev_doc.route }}')"
                   class="group flex-1 flex items-center gap-3 p-4 rounded-lg border border-[var(--outline-gray-1)] hover:border-[var(--outline-gray-2)] hover:bg-[var(--surface-gray-1)] transition-all duration-200 no-underline max-w-[50%]">
                    {{ render_icon("chevron-left", "w-5 h-5 text-[var(--ink-gray-4)] group-hover:text-[var(--ink-gray-6)] transition-colors shrink-0") }}
                    <div class="flex flex-col min-w-0">
                        <span class="text-xs font-medium text-[var(--ink-gray-4)] uppercase tracking-wide">Previous</span>
                        <span class="text-sm font-medium text-[var(--ink-gray-7)] group-hover:text-[var(--ink-gray-9)] transition-colors truncate">{{ prev_doc.title }}</span>
                    </div>
                </a>
                {% endif %}

                {% if next_doc %}
                <a href="/{{ next_doc.route }}"
                   @click.prevent="$store.navigation.navigateTo('{{ next_doc.route }}')"
                   @mouseenter="$store.navigation.prefetch('{{ next_doc.route }}')"
                   class="group flex-1 flex items-center justify-end gap-3 p-4 rounded-lg border border-[var(--outline-gray-1)] hover:border-[var(--outline-gray-2)] hover:bg-[var(--surface-gray-1)] transition-all duration-200 no-underline max-w-[50%] {{ 'ml-auto' if not prev_doc else '' }}">
                    <div class="flex flex-col items-end min-w-0">
                        <span class="text-xs font-medium text-[var(--ink-gray-4)] uppercase tracking-wide">Next</span>
                        <span class="text-sm font-medium text-[var(--ink-gray-7)] group-hover:text-[var(--ink-gray-9)] transition-colors truncate">{{ next_doc.title }}</span>
                    </div>
                    {{ render_icon("chevron-right", "w-5 h-5 text-[var(--ink-gray-4)] group-hover:text-[var(--ink-gray-6)] transition-colors shrink-0") }}
                </a>
                {% endif %}
            </div>
            {% endif %}
        </nav>

        <!-- Feedback Widget (Mobile/Tablet only - hidden on xl screens where it shows in TOC sidebar) -->
        {% if wiki_space and wiki_space.enable_feedback_collection %}
        <div class="xl:hidden">
            {% include "templates/wiki/includes/feedback_widget.html" %}
        </div>
        {% endif %}
    </article>

    {% include "templates/wiki/includes/toc.html" %}
</div>

<script>
    // Store initial markdown globally for dynamic updates
    window.wikiPageMarkdown = {{ raw_markdown | tojson }};

    function wikiDocument() {
        return {
            copied: false,

            get markdown() {
                return window.wikiPageMarkdown || '';
            },

            copyMarkdown() {
                navigator.clipboard.writeText(this.markdown).then(() => {
                    this.copied = true;
                    setTimeout(() => {
                        this.copied = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy markdown:', err);
                });
            },

            getAIUrl(provider) {
                const encodedContent = encodeURIComponent(this.markdown);
                const urls = {
                    'claude': `https://claude.ai/new?q=${encodedContent}`,
                    'openai': `https://chatgpt.com/?q=${encodedContent}`,
                    't3': `https://t3.chat/new?q=${encodedContent}`,
                    'perplexity': `https://www.perplexity.ai/search?q=${encodedContent}`
                };
                return urls[provider] || '#';
            }
        }
    }
</script>
{% endblock %}