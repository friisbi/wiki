{% from "templates/wiki/macros/buttons.html" import render_icon %}
{% from "templates/wiki/macros/sidebar_tree.html" import render_wiki_tree %}

<!-- Mobile Navigation Container - Only visible on smaller screens -->
<div class="xl:hidden" x-data="mobileNav()">
    <!-- Mobile Header -->
    <header class="sticky top-0 z-30 bg-[var(--surface-white)] border-b border-[var(--outline-gray-1)]">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Left: Logo and Menu Toggle -->
            <div class="flex items-center gap-3">
                <button @click="toggleSidebar()"
                        class="p-2 -ml-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                    <template x-if="!sidebarOpen">
                        {{ render_icon("menu") }}
                    </template>
                    <template x-if="sidebarOpen">
                        {{ render_icon("x") }}
                    </template>
                </button>
                <div class="flex items-center gap-2">
                    {% if wiki_space.light_mode_logo %}
                    <img class="size-6" src="{{ wiki_space.light_mode_logo }}"/>
                    {% endif %}
                    <span class="font-semibold text-[var(--ink-gray-9)]">{{ wiki_space.space_name or _("Wiki") }}</span>
                </div>
            </div>

            <!-- Right: Navbar items, Search and Theme Toggle -->
            <div class="flex items-center gap-1">
                {% for item in navbar_items %}
                    {% if item.icon %}
                    <a href="{{ item.url }}"
                       target="_blank" rel="noopener noreferrer"
                       title="{{ item.label }}"
                       class="p-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                        {{ render_icon(item.icon) }}
                    </a>
                    {% endif %}
                {% endfor %}
                <button @click="$dispatch('open-search')"
                        class="p-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                    {{ render_icon("search") }}
                </button>
                <button @click="$store.theme.toggle()"
                        class="p-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                    <template x-if="$store.theme.isDark">
                        {{ render_icon("sun") }}
                    </template>
                    <template x-if="!$store.theme.isDark">
                        {{ render_icon("moon") }}
                    </template>
                </button>
            </div>
        </div>

        <!-- Mobile TOC Dropdown -->
        <div class="border-t border-[var(--outline-gray-1)]" x-show="hasToc" x-cloak>
            <button @click="tocOpen = !tocOpen"
                    class="w-full flex items-center justify-between px-4 py-2.5 text-sm text-[var(--ink-gray-7)] hover:bg-[var(--surface-gray-2)] transition-colors duration-200">
                <div class="flex items-center gap-2">
                    {{ render_icon("list") }}
                    <span>On this page</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[var(--ink-gray-5)] truncate max-w-32" x-text="activeTocText"></span>
                    <svg class="w-4 h-4 transition-transform duration-200 shrink-0" :class="tocOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>

            <!-- TOC Dropdown Content -->
            <div x-show="tocOpen"
                 x-collapse
                 class="border-t border-[var(--outline-gray-1)] bg-[var(--surface-gray-1)]">
                <nav class="py-2 max-h-64 overflow-y-auto">
                    <template x-for="heading in tocHeadings" :key="heading.id">
                        <a :href="'#' + heading.id"
                           @click.prevent="scrollToHeading(heading.id); tocOpen = false"
                           :class="activeTocId === heading.id
                               ? 'text-[var(--ink-gray-9)] font-medium bg-[var(--surface-gray-2)]'
                               : 'text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)]'"
                           :style="`padding-left: ${1 + (heading.level - 2) * 0.75}rem`"
                           class="flex items-center gap-2 px-4 py-2 text-sm transition-colors duration-200">
                           <svg class="w-3 h-3 shrink-0" :class="activeTocId === heading.id ? 'text-[var(--ink-gray-7)]' : 'text-[var(--ink-gray-4)]'" fill="currentColor" viewBox="0 0 8 8">
                               <circle cx="4" cy="4" r="3"/>
                           </svg>
                           <span x-text="heading.text"></span>
                        </a>
                    </template>
                </nav>
            </div>
        </div>
    </header>

    <!-- Mobile Sidebar Overlay -->
    <div x-show="sidebarOpen"
         x-transition:enter="transition-opacity duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="closeSidebar()"
         class="fixed inset-0 bg-black/50 z-40"
         x-cloak>
    </div>

    <!-- Mobile Bottom Sheet Panel -->
    <div x-show="sidebarOpen"
         x-ref="bottomSheet"
         x-transition:enter="transition-transform duration-300 ease-out"
         x-transition:enter-start="translate-y-full"
         x-transition:enter-end="translate-y-0"
         x-transition:leave="transition-transform duration-300 ease-in"
         x-transition:leave-start="translate-y-0"
         x-transition:leave-end="translate-y-full"
         :style="isDragging ? `transform: translateY(${Math.max(0, dragOffset)}px); transition: none;` : ''"
         class="fixed left-0 right-0 bottom-0 max-h-[85vh] bg-[var(--surface-modal)] z-50 flex flex-col rounded-t-2xl shadow-xl"
         x-cloak>

        <!-- Drag Handle -->
        <div class="flex justify-center py-4 cursor-grab active:cursor-grabbing touch-none"
             @mousedown="startDrag($event)"
             @touchstart.passive="startDrag($event)"
             @click="closeSidebar()">
            <div class="h-1.5 w-12 rounded-full bg-[var(--outline-gray-2)]"></div>
        </div>

        <!-- Bottom Sheet Header -->
        <div class="px-4 pb-3 border-b border-[var(--outline-gray-1)] flex items-center justify-between">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                {% if wiki_space.light_mode_logo %}
                <img class="size-7 flex-shrink-0" src="{{ wiki_space.light_mode_logo }}"/>
                {% endif %}
                <h3 class="text-lg font-semibold text-[var(--ink-gray-9)] truncate">{{ wiki_space.space_name or _("Wiki") }}</h3>
                {% if wiki_spaces_for_switcher and wiki_spaces_for_switcher|length > 1 %}
                <button @click="spaceSwitcherOpen = !spaceSwitcherOpen"
                        class="p-1.5 rounded hover:bg-[var(--surface-gray-2)] transition-colors duration-200 flex-shrink-0"
                        title="Switch wiki space">
                    <svg class="w-4 h-4 text-[var(--ink-gray-5)] transition-transform duration-200" :class="{ 'rotate-180': spaceSwitcherOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
            <button @click="closeSidebar()"
                    class="p-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200 flex-shrink-0">
                {{ render_icon("x") }}
            </button>
        </div>

        {% if wiki_spaces_for_switcher and wiki_spaces_for_switcher|length > 1 %}
        <!-- Space Switcher Dropdown -->
        <div x-show="spaceSwitcherOpen"
             x-collapse
             class="border-b border-[var(--outline-gray-1)] bg-[var(--surface-gray-1)]">
            <div class="py-2 max-h-48 overflow-y-auto">
                {% for space in wiki_spaces_for_switcher %}
                <a href="/{{ space.route }}"
                   class="flex items-center justify-between gap-3 px-4 py-2.5 text-sm transition-colors duration-150 {{ 'bg-[var(--surface-gray-2)] text-[var(--ink-gray-9)] font-medium' if space.name == wiki_space.name else 'text-[var(--ink-gray-7)] hover:bg-[var(--surface-gray-2)] hover:text-[var(--ink-gray-9)]' }}">
                    <span class="truncate">{{ space.space_name }}</span>
                    {% if space.name == wiki_space.name %}
                    <svg class="w-4 h-4 text-[var(--ink-gray-9)] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Bottom Sheet Navigation -->
        <nav class="py-2 flex-1 overflow-y-auto" @click="handleNavClick($event)">
            {{ render_wiki_tree(nested_tree, current_route=doc.route if doc else '') }}
        </nav>

        {% if navbar_items %}
        <!-- Navbar Links -->
        <div class="p-3 border-t border-[var(--outline-gray-1)] bg-[var(--surface-white)]">
            <div class="flex flex-wrap items-center gap-2">
                {% for item in navbar_items %}
                    {% if item.icon %}
                    <a href="{{ item.url }}"
                       target="_blank" rel="noopener noreferrer"
                       title="{{ item.label }}"
                       class="p-2 text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                        {{ render_icon(item.icon, "w-5 h-5") }}
                    </a>
                    {% else %}
                    <a href="{{ item.url }}"
                       target="_blank" rel="noopener noreferrer"
                       class="px-2 py-1.5 text-sm text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200">
                        {{ item.label }}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function mobileNav() {
        return {
            sidebarOpen: false,
            tocOpen: false,
            spaceSwitcherOpen: false,
            tocHeadings: [],
            activeTocId: '',
            activeTocText: '',
            hasToc: false,

            // Drag state for bottom sheet
            isDragging: false,
            dragOffset: 0,
            dragStartY: 0,

            // Sidebar tree expanded states (same as wikiSidebar)
            expandedStates: Alpine.$persist({}).as('wiki-mobile-expanded'),
            currentRoute: '{{ doc.route if doc else "" }}',

            init() {
                // Auto-expand parents of current page
                this.expandCurrentPageParents();

                // Add global event listeners for drag
                document.addEventListener('mousemove', this.onDrag.bind(this));
                document.addEventListener('mouseup', this.endDrag.bind(this));
                document.addEventListener('touchmove', this.onDrag.bind(this), { passive: false });
                document.addEventListener('touchend', this.endDrag.bind(this));

                // Listen for TOC updates from the main document component
                this.$watch('$root.headings', (headings) => {
                    if (headings && headings.length > 0) {
                        this.tocHeadings = headings;
                        this.hasToc = true;
                    }
                });

                this.$watch('$root.activeId', (activeId) => {
                    this.activeTocId = activeId;
                    const heading = this.tocHeadings.find(h => h.id === activeId);
                    this.activeTocText = heading ? heading.text : '';
                });

                // Initialize from root if available
                this.$nextTick(() => {
                    if (this.$root.headings && this.$root.headings.length > 0) {
                        this.tocHeadings = this.$root.headings;
                        this.hasToc = true;
                        this.activeTocId = this.$root.activeId || '';
                        const heading = this.tocHeadings.find(h => h.id === this.activeTocId);
                        this.activeTocText = heading ? heading.text : '';
                    }
                });
            },

            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                document.body.style.overflow = this.sidebarOpen ? 'hidden' : '';
            },

            closeSidebar() {
                this.sidebarOpen = false;
                document.body.style.overflow = '';
            },

            scrollToHeading(id) {
                const element = document.getElementById(id);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    history.pushState(null, null, `#${id}`);
                }
            },

            handleNavClick(event) {
                const link = event.target.closest('a');
                if (link) {
                    this.closeSidebar();
                }
            },

            // Sidebar tree methods (same as wikiSidebar)
            toggleNode(nodeId) {
                this.expandedStates[nodeId] = !this.expandedStates[nodeId];
            },

            isExpanded(nodeId) {
                return this.expandedStates[nodeId] || false;
            },

            // Drag handlers for bottom sheet
            startDrag(event) {
                this.isDragging = true;
                this.dragStartY = event.type === 'touchstart' ? event.touches[0].clientY : event.clientY;
                this.dragOffset = 0;
            },

            onDrag(event) {
                if (!this.isDragging) return;

                const currentY = event.type === 'touchmove' ? event.touches[0].clientY : event.clientY;
                this.dragOffset = currentY - this.dragStartY;

                // Prevent scrolling while dragging
                if (event.type === 'touchmove' && this.dragOffset > 0) {
                    event.preventDefault();
                }
            },

            endDrag() {
                if (!this.isDragging) return;

                this.isDragging = false;

                // If dragged down more than 100px, close the sheet
                if (this.dragOffset > 100) {
                    this.closeSidebar();
                }

                this.dragOffset = 0;
            },

            expandCurrentPageParents() {
                if (!this.currentRoute) return;

                this.$nextTick(() => {
                    const currentPageElement = document.querySelector(`[data-route="${this.currentRoute}"]`);
                    if (!currentPageElement) return;

                    let parentElement = currentPageElement.parentElement;
                    while (parentElement) {
                        if (parentElement.classList.contains('wiki-children')) {
                            const parentItem = parentElement.parentElement;
                            if (parentItem) {
                                const parentContent = parentItem.querySelector('.wiki-item-content[data-node-id]');
                                if (parentContent) {
                                    const nodeId = parentContent.getAttribute('data-node-id');
                                    if (nodeId) {
                                        this.expandedStates[nodeId] = true;
                                    }
                                }
                            }
                        }
                        parentElement = parentElement.parentElement;
                    }
                });
            }
        }
    }
</script>
