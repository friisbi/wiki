{% from "templates/wiki/macros/sidebar_tree.html" import render_wiki_tree %}
{% from "templates/wiki/macros/buttons.html" import ghost_button_full, icon_button, render_icon %}

<div class="wiki-sidebar hidden xl:flex bg-[var(--surface-gray-1)] border-r border-[var(--outline-gray-1)] fixed left-0 top-0 h-screen flex-col transition-all duration-300 overflow-hidden z-40"
     x-data="wikiSidebar()"
     :class="isCollapsed ? 'xl:w-0 xl:border-r-0' : 'xl:w-72'"
     x-cloak
     x-show="!isCollapsed"
     x-transition:enter="transition-all duration-300"
     x-transition:enter-start="w-0 opacity-0"
     x-transition:enter-end="w-72 opacity-100"
     x-transition:leave="transition-all duration-300"
     x-transition:leave-start="w-72 opacity-100"
     x-transition:leave-end="w-0 opacity-0">

    <!-- Fixed Header -->
    <div class="p-4 border-b border-[var(--outline-gray-1)] bg-[var(--surface-white)] flex-shrink-0">
        <div class="flex items-center gap-3">
            {% if wiki_space.light_mode_logo %}
            <img class="size-8" src="{{ wiki_space.light_mode_logo }}"/>
            {% endif %}
            <h3 class="text-lg font-semibold text-[var(--ink-gray-9)]">{{ wiki_space.space_name or _("Wiki") }}</h3>
        </div>
    </div>

    <!-- Scrollable Navigation -->
    <nav class="py-2 flex-1 overflow-y-auto">
        {{ render_wiki_tree(nested_tree, current_route=doc.route if doc else '') }}
    </nav>

    <!-- Fixed Footer with Theme Toggle and Collapse -->
    <div class="p-3 border-t border-[var(--outline-gray-1)] bg-[var(--surface-white)] flex-shrink-0 space-y-2">
        <!-- Theme Toggle -->
        <button @click="$store.theme.toggle()"
                class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200 cursor-pointer">
            <template x-if="$store.theme.isDark">
                {{ render_icon("sun", "mr-2") }}
            </template>
            <template x-if="!$store.theme.isDark">
                {{ render_icon("moon", "mr-2") }}
            </template>
            <span x-text="$store.theme.isDark ? 'Light Mode' : 'Dark Mode'"></span>
        </button>

        <!-- Collapse Button -->
        <button @click="toggleSidebar()"
                class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)] hover:bg-[var(--surface-gray-2)] rounded-md transition-colors duration-200 cursor-pointer">
            {{ render_icon("chevron-left", "mr-2 transition-transform duration-200") }}
            <span>Collapse</span>
        </button>
    </div>
</div>

<!-- Collapse/Expand Toggle Button (visible when sidebar is collapsed, only on xl screens) -->
<div x-show="$store.sidebar.isCollapsed"
     x-data
     class="hidden xl:block fixed left-2 bottom-4 z-50 transition-opacity duration-300">
    {{ icon_button(icon="chevron-right", click="$store.sidebar.toggle()") }}
</div>

<script>
    // Initialize Alpine.js stores
    document.addEventListener('alpine:init', () => {
        // Get initial theme from localStorage or system preference
        const stored = localStorage.getItem('wiki-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initialIsDark = stored ? stored === 'dark' : prefersDark;

        // Set initial theme on document
        const initialTheme = initialIsDark ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', initialTheme);

        // Theme store for dark/light mode
        Alpine.store('theme', {
            isDark: initialIsDark,
            toggle() {
                this.isDark = !this.isDark;
                const newTheme = this.isDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('wiki-theme', newTheme);
            }
        });

        // Sidebar store for collapse state
        Alpine.store('sidebar', {
            isCollapsed: Alpine.$persist(false),
            toggle() {
                this.isCollapsed = !this.isCollapsed;
            }
        });

        // Navigation store for client-side page transitions
        Alpine.store('navigation', {
            loading: false,
            currentRoute: '{{ doc.route if doc else "" }}',
            prefetchCache: {},

            init() {
                // Handle browser back/forward
                window.addEventListener('popstate', (event) => {
                    if (event.state?.route) {
                        this.navigateTo(event.state.route, false);
                    }
                });
                // Set initial state
                history.replaceState({ route: this.currentRoute }, '', window.location.pathname);
            },

            async prefetch(route) {
                if (route === this.currentRoute || this.prefetchCache[route]) return;

                try {
                    const response = await fetch('/api/method/wiki.frappe_wiki.doctype.wiki_document.wiki_document.get_page_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ route })
                    });
                    const data = await response.json();
                    if (data.message) {
                        this.prefetchCache[route] = data.message;
                    }
                } catch (e) {
                    // Silently fail - prefetch is just an optimization
                }
            },

            async navigateTo(route, pushState = true) {
                if (route === this.currentRoute) return;

                // Check prefetch cache first
                if (this.prefetchCache[route]) {
                    this.updateContent(this.prefetchCache[route]);
                    this.currentRoute = route;
                    if (pushState) {
                        history.pushState({ route }, '', '/' + route);
                    }
                    return;
                }

                this.loading = true;

                try {
                    const response = await fetch('/api/method/wiki.frappe_wiki.doctype.wiki_document.wiki_document.get_page_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ route })
                    });
                    const data = await response.json();

                    if (data.message) {
                        this.updateContent(data.message);
                        this.currentRoute = route;
                        if (pushState) {
                            history.pushState({ route }, '', '/' + route);
                        }
                    } else {
                        throw new Error('Invalid response');
                    }
                } catch (error) {
                    // Fallback to full page load
                    window.location.href = '/' + route;
                } finally {
                    this.loading = false;
                }
            },

            updateContent(data) {
                // Update page title
                document.title = data.title;
                const titleEl = document.getElementById('wiki-page-title');
                if (titleEl) titleEl.textContent = data.title;

                // Update content
                const contentEl = document.getElementById('wiki-content');
                if (contentEl) contentEl.innerHTML = data.content_html;

                // Update prev/next navigation
                this.updateNavButtons(data.prev_doc, data.next_doc);

                // Update raw markdown for wikiDocument() component
                window.wikiPageMarkdown = data.raw_markdown;

                // Update edit link
                const editLink = document.getElementById('wiki-edit-link');
                if (editLink) editLink.setAttribute('href', data.edit_link);

                // Reinitialize TOC
                if (Alpine.store('toc')) {
                    Alpine.store('toc').refresh();
                }

                // Re-apply syntax highlighting and code block enhancements
                if (typeof initCodeBlocks === 'function') {
                    initCodeBlocks();
                } else if (typeof hljs !== 'undefined') {
                    hljs.highlightAll();
                }

                // Scroll to top
                window.scrollTo(0, 0);
            },

            updateNavButtons(prevDoc, nextDoc) {
                const navContainer = document.getElementById('wiki-nav-buttons');
                if (!navContainer) return;

                let html = '';

                if (prevDoc || nextDoc) {
                    const justifyClass = prevDoc && nextDoc ? 'justify-between' : (prevDoc ? 'justify-start' : 'justify-end');
                    html = `<div class="flex items-stretch gap-4 ${justifyClass}">`;

                    if (prevDoc) {
                        html += `
                            <a href="/${prevDoc.route}"
                               @click.prevent="$store.navigation.navigateTo('${prevDoc.route}')"
                               @mouseenter="$store.navigation.prefetch('${prevDoc.route}')"
                               class="group flex-1 flex items-center gap-3 p-4 rounded-lg border border-[var(--outline-gray-1)] hover:border-[var(--outline-gray-2)] hover:bg-[var(--surface-gray-1)] transition-all duration-200 no-underline max-w-[50%]">
                                <svg class="w-5 h-5 text-[var(--ink-gray-4)] group-hover:text-[var(--ink-gray-6)] transition-colors shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                <div class="flex flex-col min-w-0">
                                    <span class="text-xs font-medium text-[var(--ink-gray-4)] uppercase tracking-wide">Previous</span>
                                    <span class="text-sm font-medium text-[var(--ink-gray-7)] group-hover:text-[var(--ink-gray-9)] transition-colors truncate">${prevDoc.title}</span>
                                </div>
                            </a>`;
                    }

                    if (nextDoc) {
                        const mlClass = !prevDoc ? 'ml-auto' : '';
                        html += `
                            <a href="/${nextDoc.route}"
                               @click.prevent="$store.navigation.navigateTo('${nextDoc.route}')"
                               @mouseenter="$store.navigation.prefetch('${nextDoc.route}')"
                               class="group flex-1 flex items-center justify-end gap-3 p-4 rounded-lg border border-[var(--outline-gray-1)] hover:border-[var(--outline-gray-2)] hover:bg-[var(--surface-gray-1)] transition-all duration-200 no-underline max-w-[50%] ${mlClass}">
                                <div class="flex flex-col items-end min-w-0">
                                    <span class="text-xs font-medium text-[var(--ink-gray-4)] uppercase tracking-wide">Next</span>
                                    <span class="text-sm font-medium text-[var(--ink-gray-7)] group-hover:text-[var(--ink-gray-9)] transition-colors truncate">${nextDoc.title}</span>
                                </div>
                                <svg class="w-5 h-5 text-[var(--ink-gray-4)] group-hover:text-[var(--ink-gray-6)] transition-colors shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>`;
                    }

                    html += '</div>';
                }

                navContainer.innerHTML = html;
            }
        });
    });

    function wikiSidebar() {
        return {
            // Store expanded states with persistence
            expandedStates: Alpine.$persist({}),
            currentRoute: '{{ doc.route if doc else "" }}',
            
            get isCollapsed() {
                return this.$store.sidebar.isCollapsed;
            },
            
            init() {
                // Auto-expand parents of current page
                this.expandCurrentPageParents();
                
                // Debug: log all route elements
                this.$nextTick(() => {
                    const allRouteElements = document.querySelectorAll('[data-route]');
                });
            },
            
            toggleSidebar() {
                this.$store.sidebar.toggle();
            },
            
            toggleNode(nodeId) {
                // Toggle the expanded state for this node
                this.expandedStates[nodeId] = !this.expandedStates[nodeId];
            },
            
            isExpanded(nodeId) {
                // Return whether this node is expanded (default to false)
                return this.expandedStates[nodeId] || false;
            },
            
            expandCurrentPageParents() {
                // Find and expand all parent groups of the current page
                if (!this.currentRoute) return;
                
                // Wait for DOM to be fully rendered
                this.$nextTick(() => {
                    // Find the current page element
                    const currentPageElement = document.querySelector(`[data-route="${this.currentRoute}"]`);
                    if (!currentPageElement) return;
                    
                    // Find all parent group containers and expand them
                    let parentElement = currentPageElement.parentElement;
                    while (parentElement) {
                        // Look for parent wiki-children containers
                        if (parentElement.classList.contains('wiki-children')) {
                            // Find the sibling wiki-item-content that has a data-node-id
                            const parentItem = parentElement.parentElement;
                            if (parentItem) {
                                const parentContent = parentItem.querySelector('.wiki-item-content[data-node-id]');
                                if (parentContent) {
                                    const nodeId = parentContent.getAttribute('data-node-id');
                                    if (nodeId) {
                                        this.expandedStates[nodeId] = true;
                                    }
                                }
                            }
                        }
                        parentElement = parentElement.parentElement;
                    }
                });
            }
        }
    }
</script>
