<!-- Table of Contents (Right Sidebar) -->
<aside class="hidden xl:block fixed right-6 top-24 w-56">
    <nav class="max-h-[calc(100vh-12rem)] overflow-y-auto no-scrollbar">
        <template x-if="headings.length > 0">
            <div>
                <h3 class="text-sm font-semibold text-[var(--ink-gray-9)] mb-3">On this page</h3>
                <ul class="space-y-2">
                    <template x-for="heading in headings" :key="heading.id">
                        <li>
                            <a :href="'#' + heading.id"
                               @click.prevent="scrollToHeading(heading.id)"
                               :class="activeId === heading.id
                                   ? 'text-[var(--ink-gray-9)] font-medium'
                                   : 'text-[var(--ink-gray-5)] hover:text-[var(--ink-gray-9)]'"
                               :style="`padding-left: ${(heading.level - 2) * 0.75}rem`"
                               class="block text-sm transition-colors duration-200"
                               x-text="heading.text">
                            </a>
                        </li>
                    </template>
                </ul>
            </div>
        </template>
    </nav>

    {% if wiki_space and wiki_space.enable_feedback_collection %}
    {% include "templates/wiki/includes/feedback_widget.html" %}
    {% endif %}
</aside>

<script>
    // Initialize TOC store for external refresh capability
    document.addEventListener('alpine:init', () => {
        Alpine.store('toc', {
            refreshCallback: null,

            setRefreshCallback(callback) {
                this.refreshCallback = callback;
            },

            refresh() {
                if (this.refreshCallback) {
                    this.refreshCallback();
                }
            }
        });
    });

    function tocScrollSpy(contentId = 'wiki-content') {
        return {
            headings: [],
            activeId: '',
            observer: null,

            init() {
                this.extractHeadings(contentId);
                this.setupScrollSpy();

                // Register refresh callback with store
                Alpine.store('toc').setRefreshCallback(() => {
                    this.refresh();
                });
            },

            refresh() {
                // Disconnect existing observer
                if (this.observer) {
                    this.observer.disconnect();
                }

                // Re-extract headings and setup scroll spy
                this.extractHeadings(contentId);
                this.setupScrollSpy();
            },

            extractHeadings(contentId) {
                const content = document.getElementById(contentId);
                if (!content) return;

                const headingElements = content.querySelectorAll('h2, h3');
                this.headings = Array.from(headingElements).map((heading, index) => {
                    // Ensure heading has an ID for linking
                    if (!heading.id) {
                        heading.id = `heading-${index}`;
                    }
                    // Get text before adding anchor
                    const text = heading.textContent.trim();
                    // Add anchor link if not already present
                    this.addAnchorLink(heading);
                    return {
                        id: heading.id,
                        text: text,
                        level: parseInt(heading.tagName.charAt(1))
                    };
                });

                // Set initial active heading
                if (this.headings.length > 0) {
                    this.activeId = this.headings[0].id;
                } else {
                    this.activeId = '';
                }
            },

            setupScrollSpy() {
                if (this.headings.length === 0) return;

                const options = {
                    root: null,
                    rootMargin: '-80px 0px -70% 0px',
                    threshold: 0
                };

                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            this.activeId = entry.target.id;
                        }
                    });
                }, options);

                this.headings.forEach(heading => {
                    const element = document.getElementById(heading.id);
                    if (element) {
                        this.observer.observe(element);
                    }
                });
            },

            scrollToHeading(id) {
                const element = document.getElementById(id);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Update active immediately for better UX
                    this.activeId = id;
                    // Update URL hash without jumping
                    history.pushState(null, null, `#${id}`);
                }
            },

            addAnchorLink(heading) {
                // Skip if anchor already exists
                if (heading.querySelector('.heading-anchor')) return;

                const anchor = document.createElement('a');
                anchor.href = `#${heading.id}`;
                anchor.className = 'heading-anchor';
                anchor.setAttribute('aria-label', `Link to ${heading.textContent.trim()}`);
                anchor.textContent = '#';

                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.scrollToHeading(heading.id);
                    // Copy URL to clipboard
                    navigator.clipboard.writeText(window.location.origin + window.location.pathname + `#${heading.id}`);
                });

                heading.insertBefore(anchor, heading.firstChild);
            },

            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                }
            }
        }
    }
</script>
