{% from "templates/wiki/macros/buttons.html" import render_icon %}

<!-- Search Modal -->
<div x-data="wikiSearch()"
     x-cloak
     @open-search.window="open()"
     @keydown.window.meta.k.prevent="open()"
     @keydown.window.ctrl.k.prevent="open()"
     @keydown.escape.window="close()"
     class="relative z-50">

    <!-- Backdrop -->
    <div x-show="isOpen"
         x-transition:enter="transition-opacity ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="close()"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
    </div>

    <!-- Modal Container - Centered -->
    <div x-show="isOpen"
         class="fixed inset-0 z-50 flex items-start justify-center pt-[20vh] px-4"
         @click.self="close()">

        <!-- Modal -->
        <div x-show="isOpen"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95 -translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 -translate-y-4"
             @click.stop
             class="w-full max-w-2xl bg-[var(--surface-white)] rounded-xl shadow-2xl border border-[var(--outline-gray-1)] overflow-hidden">

            <!-- Search Input -->
            <div class="flex items-center gap-3 px-4 py-3 border-b border-[var(--outline-gray-1)]">
                {{ render_icon("search", "w-5 h-5 text-[var(--ink-gray-4)] shrink-0") }}
                <input type="text"
                       x-ref="searchInput"
                       x-model="query"
                       @input.debounce.200ms="search()"
                       placeholder="{{ _('Search documentation...') }}"
                       class="flex-1 bg-transparent text-[var(--ink-gray-9)] placeholder-[var(--ink-gray-4)] text-base outline-none">
                <kbd class="hidden sm:inline-flex text-xs text-[var(--ink-gray-4)] bg-[var(--surface-gray-2)] px-2 py-1 rounded font-sans">ESC</kbd>
            </div>

            <!-- Results -->
            <div class="max-h-[60vh] overflow-y-auto pt-2">
                <!-- Loading State -->
                <template x-if="loading">
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-6 w-6 border-2 border-[var(--ink-gray-3)] border-t-[var(--ink-gray-7)]"></div>
                    </div>
                </template>

                <!-- No Query State -->
                <template x-if="!loading && !query">
                    <div class="py-12 text-center">
                        <p class="text-[var(--ink-gray-5)]">{{ _("Type to search documentation") }}</p>
                    </div>
                </template>

                <!-- No Results State -->
                <template x-if="!loading && query && results.length === 0 && !error">
                    <div class="py-12 text-center">
                        <p class="text-[var(--ink-gray-5)]">{{ _("No results found for") }} "<span x-text="query" class="font-medium"></span>"</p>
                    </div>
                </template>

                <!-- Error State -->
                <template x-if="!loading && error">
                    <div class="py-12 text-center">
                        <p class="text-[var(--ink-gray-5)]" x-text="error"></p>
                    </div>
                </template>

                <!-- Results List -->
                <template x-if="!loading && results.length > 0">
                    <ul class="py-2">
                        <template x-for="(result, index) in results" :key="index">
                            <li>
                                <a :href="'/' + result.route"
                                   @click.prevent="navigateTo(result.route)"
                                   @mouseenter="selectedIndex = index"
                                   @keydown.enter.prevent="navigateTo(result.route)"
                                   :class="selectedIndex === index ? 'bg-[var(--surface-gray-2)]' : ''"
                                   class="flex flex-col gap-1 px-4 py-3 hover:bg-[var(--surface-gray-2)] transition-colors cursor-pointer">
                                    <span class="text-sm font-medium text-[var(--ink-gray-9)]" x-html="result.title"></span>
                                    <span class="text-xs text-[var(--ink-gray-5)] line-clamp-2" x-html="result.content"></span>
                                </a>
                            </li>
                        </template>
                    </ul>
                </template>
            </div>

            <!-- Footer -->
            <div class="flex items-center justify-between px-4 py-2 border-t border-[var(--outline-gray-1)] bg-[var(--surface-gray-1)] text-xs text-[var(--ink-gray-5)]">
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1">
                        <kbd class="px-1.5 py-0.5 bg-[var(--surface-gray-3)] rounded text-[var(--ink-gray-6)]">↵</kbd>
                        {{ _("to select") }}
                    </span>
                    <span class="flex items-center gap-1">
                        <kbd class="px-1.5 py-0.5 bg-[var(--surface-gray-3)] rounded text-[var(--ink-gray-6)]">↑↓</kbd>
                        {{ _("to navigate") }}
                    </span>
                </div>
                <span x-show="total > 0" x-text="total + ' {{ _("results") }}'"></span>
            </div>
        </div>
    </div>
</div>

<script>
    function wikiSearch() {
        return {
            isOpen: false,
            query: '',
            results: [],
            total: 0,
            loading: false,
            error: null,
            selectedIndex: 0,
            space: '{{ wiki_space.root_group if wiki_space else "" }}',

            open() {
                this.isOpen = true;
                document.body.style.overflow = 'hidden';
                this.$nextTick(() => {
                    this.$refs.searchInput.focus();
                });
            },

            close() {
                this.isOpen = false;
                document.body.style.overflow = '';
                this.query = '';
                this.results = [];
                this.total = 0;
                this.error = null;
                this.selectedIndex = 0;
            },

            async search() {
                if (!this.query.trim()) {
                    this.results = [];
                    this.total = 0;
                    this.error = null;
                    return;
                }

                this.loading = true;
                this.error = null;
                this.selectedIndex = 0;

                try {
                    const params = new URLSearchParams();
                    params.append('query', this.query);
                    if (this.space) {
                        params.append('space', this.space);
                    }

                    const response = await fetch(`/api/method/wiki.frappe_wiki.doctype.wiki_document.search.search?${params.toString()}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.exc_type) {
                        // Handle Frappe errors
                        console.error('Frappe error:', data);
                        this.error = 'Search index not available. Please contact administrator.';
                        this.results = [];
                        this.total = 0;
                    } else if (data.message) {
                        this.results = data.message.results || [];
                        this.total = data.message.total || 0;
                        this.error = null;
                    } else {
                        // Unexpected response format
                        console.warn('Unexpected response format:', data);
                        this.results = [];
                        this.total = 0;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.error = 'Search failed: ' + error.message;
                    this.results = [];
                    this.total = 0;
                } finally {
                    this.loading = false;
                }
            },

            navigateTo(route) {
                this.close();
                Alpine.store('navigation').navigateTo(route);
            },

            init() {
                // Keyboard navigation
                this.$watch('isOpen', (value) => {
                    if (value) {
                        document.addEventListener('keydown', this.handleKeydown.bind(this));
                    } else {
                        document.removeEventListener('keydown', this.handleKeydown.bind(this));
                    }
                });
            },

            handleKeydown(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.selectedIndex = Math.min(this.selectedIndex + 1, this.results.length - 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                } else if (e.key === 'Enter' && this.results.length > 0) {
                    e.preventDefault();
                    this.navigateTo(this.results[this.selectedIndex].route);
                }
            }
        }
    }
</script>
